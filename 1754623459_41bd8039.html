<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>å‘˜å·¥æ‰“å¡å¯è§†åŒ–</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    .amap-marker-label {
      background: rgba(255,255,255,0.9);
      border: 1px solid #ddd;
      padding: 2px 6px;
      border-radius: 4px;
      white-space: nowrap;
      font-size: 12px;
    }
  </style>
  <!-- é¢„åŠ è½½éœ€è¦çš„æ’ä»¶ï¼šèšåˆã€å·¥å…·æ¡ã€æ¯”ä¾‹å°ºã€è¡Œæ”¿åŒºæ£€ç´¢ -->
  <script src="https://webapi.amap.com/maps?v=2.0&key=b479b036079bc0579bc23d62cdfdfb6b&plugin=AMap.MarkerCluster,AMap.ToolBar,AMap.Scale,AMap.DistrictSearch"></script>
</head>
<body>
  <div id="map"></div>
  <script>
    // åˆå§‹åŒ–åœ°å›¾
    var map = new AMap.Map('map', {
      zoom: 5,
      center: [111.236024, 24.559199],
      viewMode: '2D'
    });

    // ç‚¹æ•°æ®
    var points = [{"name": "é¾šæ¥", "address": "å¹¿ä¸œçœç æµ·å¸‚é‡‘æ¹¾åŒºåˆ›ä¸šä¸­è·¯2å·", "province": "å¹¿ä¸œçœ", "position": [113.281266, 22.08831], "content": "<b>é¾šæ¥</b><br/>å¹¿ä¸œçœ å¹¿ä¸œçœç æµ·å¸‚é‡‘æ¹¾åŒºåˆ›ä¸šä¸­è·¯2å·"}, {"name": "é¾™è¿œå¿—", "address": "çœ‰å±±å¸‚ä¸œå¡åŒºä¸œå¡åŒºé˜³å…‰æœªæ¥åŸ(èœ€å±±è·¯å—)", "province": "å››å·çœ", "position": [103.833874, 30.068128], "content": "<b>é¾™è¿œå¿—</b><br/>å››å·çœ çœ‰å±±å¸‚ä¸œå¡åŒºä¸œå¡åŒºé˜³å…‰æœªæ¥åŸ(èœ€å±±è·¯å—)"}, {"name": "é¾™å¼€å‰", "address": "å¹¿ä¸œçœä¸œèå¸‚è¶…ä¸œè·¯82å·", "province": "å¹¿ä¸œçœ", "position": [113.914478, 23.040178], "content": "<b>é¾™å¼€å‰</b><br/>å¹¿ä¸œçœ å¹¿ä¸œçœä¸œèå¸‚è¶…ä¸œè·¯82å·"}, {"name": "é½å®—", "address": "å¹¿ä¸œçœä¸œèå¸‚è¶…ä¸œè·¯82å·", "province": "å¹¿ä¸œçœ", "position": [113.914478, 23.040178], "content": "<b>é½å®—</b><br/>å¹¿ä¸œçœ å¹¿ä¸œçœä¸œèå¸‚è¶…ä¸œè·¯82å·"}];
    var emphasizeProvinces = []; // éœ€è¦æ”¾å¤§çš„çœä»½ï¼ˆå¯ä¸ºç©ºï¼‰
    console.log('points:', points);

    var infoWin = new AMap.InfoWindow({ offset: new AMap.Pixel(0, -30) });

    // åˆ›å»ºæ ‡è®°
    var markers = points.map(function(p) {
      var icon = new AMap.Icon({
        size: new AMap.Size(25, 34),
        image: 'https://webapi.amap.com/theme/v1.3/markers/n/mark_b.png',
        imageSize: new AMap.Size(25, 34)
      });
      var m = new AMap.Marker({
        position: p.position,   // [lng, lat]
        title: p.name || '',
        icon: icon
      });
      m._meta = p; // ä¿å­˜å…ƒæ•°æ®ï¼Œä¾¿äºåç»­æŒ‰çœå¤„ç†

      m.on('click', function() {
        infoWin.setContent(
          '<div style="font-size:14px;">' +
          '<b>ğŸ‘¤ å§“åï¼š</b>' + (p.name || '') + '<br/>' +
          '<b>ğŸ“ åœ°å€ï¼š</b>' + (p.province ? p.province + ' ' : '') + (p.address || '') +
          '</div>'
        );
        infoWin.open(map, p.position);
      });
      return m;
    });

    // æŠŠæ ‡è®°å…ˆåŠ åˆ°åœ°å›¾ï¼ˆå°±ç®—åé¢æŸåŠŸèƒ½å¤±è´¥ï¼Œç‚¹ä¹Ÿèƒ½çœ‹åˆ°ï¼‰
    map.add(markers);

    // è§†é‡è‡ªé€‚åº”
    if (markers.length) {
      map.setFitView(markers, true, [50, 50, 50, 50]);
    }

    // -------------------------------
    // çœä»½åˆ†ç»„ç»Ÿè®¡ + é«˜äº® + â€œæ€»è®¡ï¼šXäººâ€
    // -------------------------------
    var provinceCounts = {};
    points.forEach(function(p) {
      var prov = (p.province || '').trim();
      if (!prov) return;
      provinceCounts[prov] = (provinceCounts[prov] || 0) + 1;
    });

    var provinces = Object.keys(provinceCounts);
    if (provinces.length) {
      var ds = new AMap.DistrictSearch({
        level: 'province',
        extensions: 'all',
        subdistrict: 0
      });

      function renderNext(i) {
        if (i >= provinces.length) return;
        var provName = provinces[i];

        // æ”¾å¤§è¯¥çœä»½çš„ç‚¹ï¼ˆå¦‚æœåœ¨å¼ºè°ƒåˆ—è¡¨ä¸­ï¼‰
        if (emphasizeProvinces.indexOf(provName) >= 0) {
          var bigIcon = new AMap.Icon({
            size: new AMap.Size(32, 44),
            image: 'https://webapi.amap.com/theme/v1.3/markers/n/mark_b.png',
            imageSize: new AMap.Size(32, 44)
          });
          markers
            .filter(function(m){ return m._meta && m._meta.province === provName; })
            .forEach(function(m){ m.setIcon(bigIcon); m.setTop(true); });
        }

        ds.search(provName, function(status, result){
          if (status === 'complete' && result.districtList && result.districtList.length) {
            var dist = result.districtList[0];
            var boundaries = dist.boundaries || [];
            var polys = boundaries.map(function(path){
              return new AMap.Polygon({
                path: path,
                strokeColor: '#1976d2',     // è¾¹ç•Œçº¿
                strokeOpacity: 0.9,
                strokeWeight: 2,
                fillColor: '#64b5f6',       // çœå¡«å……è‰²
                fillOpacity: 0.15
              });
            });
            map.add(polys);

            // çœä¸­å¿ƒæ–‡æœ¬ï¼šæ˜¾ç¤ºâ€œçœåï¼šæ€»è®¡ X äººâ€
            var center = dist.center; // [lng, lat]
            var count = provinceCounts[provName] || 0;
            var text = new AMap.Text({
              position: center,
              text: provName + 'ï¼šæ€»è®¡ ' + count + ' äºº',
              style: {
                'background': 'rgba(255,255,255,0.95)',
                'padding': '4px 8px',
                'border': '1px solid #1976d2',
                'border-radius': '4px',
                'font-weight': 'bold'
              },
              zIndex: 120
            });
            text.setMap(map);
          }
          // ä¸²è¡Œä¸‹ä¸€çœï¼Œç¨å¾®ç­‰ 120msï¼Œé¿å…è¢«é™æµ
          setTimeout(function(){ renderNext(i + 1); }, 120);
        });
      }
      renderNext(0);
    }

    // å¯ç”¨èšåˆ & æ§ä»¶ï¼ˆæ’ä»¶å·²åœ¨ script URL ä¸­é¢„åŠ è½½ï¼‰
    new AMap.MarkerCluster(map, markers, { gridSize: 80 });
    map.addControl(new AMap.ToolBar());
    map.addControl(new AMap.Scale());
  </script>
</body>
</html>