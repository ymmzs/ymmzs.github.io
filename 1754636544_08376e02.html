<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>员工打卡可视化</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
      padding: 0;
    }
  </style>
  <script src="https://webapi.amap.com/maps?v=2.0&key=b479b036079bc0579bc23d62cdfdfb6b&plugin=AMap.ToolBar,AMap.Scale"></script>
</head>
<body>
  <div id="map"></div>
  <script>
    var map = new AMap.Map('map', {
      zoom: 5,
      center: [113.462747, 24.667952],
      viewMode: '2D'
    });

    var points = [{"name": "龚来", "address": "广东省珠海市金湾区创业中路2号", "province": "广东省", "position": [113.281266, 22.08831], "content": "<b>👤 姓名：</b>龚来<br/><b>📍 地址：</b>广东省 广东省珠海市金湾区创业中路2号"}, {"name": "龙远志", "address": "眉山市东坡区东坡区阳光未来城(蜀山路南)", "province": "四川省", "position": [103.833874, 30.068128], "content": "<b>👤 姓名：</b>龙远志<br/><b>📍 地址：</b>四川省 眉山市东坡区东坡区阳光未来城(蜀山路南)"}, {"name": "龙开吉", "address": "广东省东莞市超东路82号", "province": "广东省", "position": [113.914478, 23.040178], "content": "<b>👤 姓名：</b>龙开吉<br/><b>📍 地址：</b>广东省 广东省东莞市超东路82号"}, {"name": "齐宗", "address": "广东省东莞市超东路82号", "province": "广东省", "position": [113.914478, 23.040178], "content": "<b>👤 姓名：</b>齐宗<br/><b>📍 地址：</b>广东省 广东省东莞市超东路82号"}, {"name": "黎勇", "address": "广东省深圳市龙岗区宝龙一路宝龙一路27-5号", "province": "广东省", "position": [114.286956, 22.687053], "content": "<b>👤 姓名：</b>黎勇<br/><b>📍 地址：</b>广东省 广东省深圳市龙岗区宝龙一路宝龙一路27-5号"}, {"name": "黄雄安", "address": "广东省东莞市超东路82号", "province": "广东省", "position": [113.914478, 23.040178], "content": "<b>👤 姓名：</b>黄雄安<br/><b>📍 地址：</b>广东省 广东省东莞市超东路82号"}, {"name": "黄钰松", "address": "四川省眉山市东坡区高新技术产业园区万华大道1号", "province": "四川省", "position": [103.764853, 30.036396], "content": "<b>👤 姓名：</b>黄钰松<br/><b>📍 地址：</b>四川省 四川省眉山市东坡区高新技术产业园区万华大道1号"}, {"name": "黄莹", "address": "广东省东莞市超东路82号", "province": "广东省", "position": [113.914478, 23.040178], "content": "<b>👤 姓名：</b>黄莹<br/><b>📍 地址：</b>广东省 广东省东莞市超东路82号"}, {"name": "黄立勇", "address": "广东省东莞市超东路82号", "province": "广东省", "position": [113.914478, 23.040178], "content": "<b>👤 姓名：</b>黄立勇<br/><b>📍 地址：</b>广东省 广东省东莞市超东路82号"}, {"name": "黄润龙", "address": "广东省东莞市超东路82号", "province": "广东省", "position": [113.914478, 23.040178], "content": "<b>👤 姓名：</b>黄润龙<br/><b>📍 地址：</b>广东省 广东省东莞市超东路82号"}, {"name": "黄桂贵", "address": "广东省东莞市超东路82号", "province": "广东省", "position": [113.914478, 23.040178], "content": "<b>👤 姓名：</b>黄桂贵<br/><b>📍 地址：</b>广东省 广东省东莞市超东路82号"}, {"name": "黄晨曦", "address": "广东省东莞市超东路82号", "province": "广东省", "position": [113.914478, 23.040178], "content": "<b>👤 姓名：</b>黄晨曦<br/><b>📍 地址：</b>广东省 广东省东莞市超东路82号"}, {"name": "黄晓真", "address": "广东省东莞市超东路82号", "province": "广东省", "position": [113.914478, 23.040178], "content": "<b>👤 姓名：</b>黄晓真<br/><b>📍 地址：</b>广东省 广东省东莞市超东路82号"}, {"name": "黄明真", "address": "安徽省淮北市相山区闸河路", "province": "安徽省", "position": [116.802292, 33.969743], "content": "<b>👤 姓名：</b>黄明真<br/><b>📍 地址：</b>安徽省 安徽省淮北市相山区闸河路"}, {"name": "黄方烨", "address": "常州市溧阳市溧阳市蒋店新城", "province": "江苏省", "position": [119.415721, 31.442724], "content": "<b>👤 姓名：</b>黄方烨<br/><b>📍 地址：</b>江苏省 常州市溧阳市溧阳市蒋店新城"}, {"name": "黄志国", "address": "湖北省宜昌市兴山县思乡路", "province": "湖北省", "position": [110.759097, 31.228418], "content": "<b>👤 姓名：</b>黄志国<br/><b>📍 地址：</b>湖北省 湖北省宜昌市兴山县思乡路"}, {"name": "黄尧", "address": "广东省东莞市超东路82号", "province": "广东省", "position": [113.914478, 23.040178], "content": "<b>👤 姓名：</b>黄尧<br/><b>📍 地址：</b>广东省 广东省东莞市超东路82号"}, {"name": "黄家照", "address": "广东省东莞市超东路82号", "province": "广东省", "position": [113.914478, 23.040178], "content": "<b>👤 姓名：</b>黄家照<br/><b>📍 地址：</b>广东省 广东省东莞市超东路82号"}, {"name": "黄宝光", "address": "福建省宁德市蕉城区振兴路", "province": "福建省", "position": [119.55388, 26.718301], "content": "<b>👤 姓名：</b>黄宝光<br/><b>📍 地址：</b>福建省 福建省宁德市蕉城区振兴路"}, {"name": "黄妙华", "address": "广东省东莞市超东路82号", "province": "广东省", "position": [113.914478, 23.040178], "content": "<b>👤 姓名：</b>黄妙华<br/><b>📍 地址：</b>广东省 广东省东莞市超东路82号"}, {"name": "黄俊", "address": "广东省东莞市超东路82号", "province": "广东省", "position": [113.914478, 23.040178], "content": "<b>👤 姓名：</b>黄俊<br/><b>📍 地址：</b>广东省 广东省东莞市超东路82号"}, {"name": "高鹏飞", "address": "广东省东莞市超东路82号", "province": "广东省", "position": [113.914478, 23.040178], "content": "<b>👤 姓名：</b>高鹏飞<br/><b>📍 地址：</b>广东省 广东省东莞市超东路82号"}, {"name": "高茂虎", "address": "广东省肇庆市高要区创业四路", "province": "广东省", "position": [112.792046, 23.087862], "content": "<b>👤 姓名：</b>高茂虎<br/><b>📍 地址：</b>广东省 广东省肇庆市高要区创业四路"}, {"name": "高小云", "address": "广东省东莞市超东路82号", "province": "广东省", "position": [113.914478, 23.040178], "content": "<b>👤 姓名：</b>高小云<br/><b>📍 地址：</b>广东省 广东省东莞市超东路82号"}, {"name": "骆礼军", "address": "广东省肇庆市高要区Y184与Y235交叉口东北方向1430米左右", "province": "广东省", "position": [112.458055, 23.02474], "content": "<b>👤 姓名：</b>骆礼军<br/><b>📍 地址：</b>广东省 广东省肇庆市高要区Y184与Y235交叉口东北方向1430米左右"}, {"name": "马磊", "address": "广东省东莞市超东路82号", "province": "广东省", "position": [113.914478, 23.040178], "content": "<b>👤 姓名：</b>马磊<br/><b>📍 地址：</b>广东省 广东省东莞市超东路82号"}, {"name": "马杰林", "address": "广东省东莞市超东路82号", "province": "广东省", "position": [113.914478, 23.040178], "content": "<b>👤 姓名：</b>马杰林<br/><b>📍 地址：</b>广东省 广东省东莞市超东路82号"}];
    var provinceCounts = {"广东省": 21, "四川省": 2, "安徽省": 1, "江苏省": 1, "湖北省": 1, "福建省": 1};
    var infoWin = new AMap.InfoWindow({ offset: new AMap.Pixel(0, -30) });

    // ---- 像素级偏移：同坐标全部显示 ----
    var seen = Object.create(null);
    var GOLDEN = 2.3999632297; // 黄金角(弧度)
    var PIX_BASE = 10;         // 基础像素半径，可调大些分得更开

    // 小号红色图标
    var smallRedIcon = new AMap.Icon({
      size: new AMap.Size(14, 20),
      image: 'https://webapi.amap.com/theme/v1.3/markers/n/mark_r.png',
      imageSize: new AMap.Size(14, 20)
    });

    var markers = points.map(function(p) {
      var key = p.position[0].toFixed(6) + ',' + p.position[1].toFixed(6);
      var n = (seen[key] || 0);   // 已经在该坐标放了几个
      seen[key] = n + 1;

      // 第1个不偏移；从第2个起按黄金角螺旋做像素偏移
      var offsetPx = new AMap.Pixel(0, 0);
      if (n > 0) {
        var r = PIX_BASE * Math.sqrt(n);
        var theta = GOLDEN * n;
        offsetPx = new AMap.Pixel(r * Math.cos(theta), r * Math.sin(theta));
      }

      var marker = new AMap.Marker({
        position: p.position,
        title: p.name,
        offset: offsetPx,          // 关键：像素级偏移
        icon: smallRedIcon,
        zIndex: 120 + n
      });

      marker.on('click', function() {
        infoWin.setContent('<div style="font-size:14px;">' + p.content + '</div>');
        infoWin.open(map, p.position);
      });
      return marker;
    });

    // 不用聚合，避免再次合并
    map.add(markers);
    map.setFitView(markers, true, [50,50,50,50]);

    // ---- 省名归一化，便于匹配 ----
    function normProvName(name) {
      if (!name) return '';
      return name.replace(/(省|市|特别行政区|维吾尔自治区|回族自治区|壮族自治区|自治区)$/,'');
    }

    // ---- 加载省份 GeoJSON 并高亮（浅蓝）----
    fetch('https://geo.datav.aliyun.com/areas_v3/bound/100000_full.json')
      .then(res => res.json())
      .then(geojson => {
        geojson.features.forEach(f => {
          var provRaw = f.properties.name; // 如“广东”或“广东省”
          var key = normProvName(provRaw);
          var count = provinceCounts[provRaw] || provinceCounts[key] || provinceCounts[key + '省'] || 0;
          if (count <= 0) return;

          var baseOpts = {
            strokeColor: '#1976d2',  // 深蓝描边
            strokeWeight: 1,
            fillColor: '#64b5f6',    // 浅蓝填充
            fillOpacity: 0.08
          };

          function addPoly(path) {
            var poly = new AMap.Polygon(Object.assign({ path: path }, baseOpts));
            poly.on('mouseover', function() {
              poly.setOptions({ fillOpacity: 0.25, strokeWeight: 2 });
            });
            poly.on('mouseout', function() {
              poly.setOptions({ fillOpacity: 0.08, strokeWeight: 1 });
            });
            map.add(poly);
            return poly;
          }

          var polys = [];
          if (f.geometry.type === 'Polygon') {
            // coordinates: [ring1, ring2(洞), ...]
            polys.push(addPoly(f.geometry.coordinates));
          } else if (f.geometry.type === 'MultiPolygon') {
            // coordinates: [poly1([rings]), poly2([rings]), ...]
            f.geometry.coordinates.forEach(function(onePolygonRings) {
              polys.push(addPoly(onePolygonRings));
            });
          }

          if (polys.length) {
            // 合并 bounds 取中心点标注人数
            var unionBounds = polys[0].getBounds();
            for (var i = 1; i < polys.length; i++) {
              unionBounds = unionBounds.union(polys[i].getBounds());
            }
            var center = unionBounds.getCenter();
            var text = new AMap.Text({
              position: center,
              text: provRaw + '：共' + count + ' 人',
              style: {
                'background': 'rgba(255,255,255,0.95)',
                'padding': '4px 8px',
                'border': '1px solid #1976d2',
                'border-radius': '4px',
                'font-weight': 'bold'
              },
              zIndex: 200
            });
            text.setMap(map);
          }
        });
      })
      .catch(err => {
        console.error('加载省份 GeoJSON 失败：', err);
      });

    map.addControl(new AMap.ToolBar());
    map.addControl(new AMap.Scale());
  </script>
</body>
</html>